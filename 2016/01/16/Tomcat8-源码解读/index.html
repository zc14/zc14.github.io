

<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="http://tajs.qq.com/stats?sId=44218032" charset="UTF-8"></script>
  <script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?7192fa361f5cabb11d8a22de41c1ba8f";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>
  
  <title>Tomcat8 源码解读 | zc14-紫竹林</title>
  <meta name="author" content="周聪">
  
  <meta name="description" content="加班...">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Tomcat8 源码解读"/>
  <meta property="og:site_name" content="zc14-紫竹林"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/imgs/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="zc14-紫竹林" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//libs.baidu.com/jquery/1.8.0/jquery.min.js"></script>
</head>


<body>
  <header><div>
		
			<div id="imglogo">
				<a href="/"><img src="/imgs/logo.png" alt="zc14-紫竹林" title="zc14-紫竹林"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name">zc14-紫竹林</h1>
				<h2 class="blog-motto">叽里呱啦</h2>
			</div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li> <a href="/atom.xml">RSS</a> </li>
				</ul>
			</nav>			
</div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header class="article-info clearfix">
  <h1 itemprop="name">
	Tomcat8 源码解读
  </h1>
  <p class="article-author">By
    
      <a href="http://zc14.github.io" title="周聪">周聪</a>
    </p>
  <p class="article-time">
    <time datetime="2016-01-16T02:36:59.000Z" itemprop="datePublished">2016-01-16</time>
    更新日期:<time datetime="2016-01-16T10:51:29.814Z" itemprop="dateModified">2016-01-16</time>
    
  </p>
</header>
    <div class="entry">
		
        <p>关于学习tomcat源码的一些知识总结<br><a id="more"></a></p>
<h2 id="总体介绍">总体介绍</h2><p>  <em><a href="http://tomcat.apache.org/tomcat-8.0-doc/config/http.html" target="_blank" rel="external">http://tomcat.apache.org/tomcat-8.0-doc/config/http.html</a></em><br>  1.AJP性能优于HTTP，网上有很多测试案例。所以正式环境优先使用二进制数据的AJP(需要Apache/ngnix配合使用)<br>  2.官方描述简单介绍</p>
<h3 id="[Connectors-HTTP]">[Connectors-HTTP]</h3><p><strong>Each incoming request requires a thread for the duration of that request.</strong><br><em>每个请求是会有一个对应的线程去进行处理。</em> If more simultaneous requests are received than can be handled by the currently available request processing threads, additional threads will be created up to the configured maximum (the value of the <strong>maxThreads</strong> attribute). If still more simultaneous requests are received, they are stacked up inside the server socket created by the Connector, up to the configured maximum (the value of the <strong>acceptCount</strong> attribute). Any further simultaneous requests will receive “connection refused” errors, until resources are available to process them.</p>
<h3 id="[Connectors-AJP]">[Connectors-AJP]</h3><p>The AJP Connector element represents a Connector component that communicates with a web connector via the AJP protocol. This is used for cases where you wish to invisibly integrate Tomcat into an existing (or new) Apache installation, and you want Apache to handle the <strong>static content</strong> contained in the web application, and/or utilize Apache’s SSL processing.可以看出AJP需要与Apache配合使用，访问静态资源文件有优势。Tomcat的作用更适合解析处理Servlet/Jsp。</p>
<h3 id="[Executor]">[Executor]</h3><p><strong>The Executor represents a thread pool that can be shared between components in Tomcat. Historically there has been a thread pool per connector created</strong> but this allows you to share a thread pool, between (primarily) connector but also other components when those get configured to support executors.Executor代表在tomcat组件之间共享的一个线程池。历史版本一个connector有一个自己的线程池。在tomcat6改变。<br>The executor has to implement the <strong>org.apache.catalina.Executor</strong> interface.<br>The executor is a <strong>nested element to the Service element</strong>. And in order for it to be picked up by the connectors, the Executor element has to appear prior to the Connector element in <em>server.xml</em>。<br>在Service接口中有对Executor提供方法操作声明：addExecutor/findExecutors/getExecutor/removeExecutor。<br><strong>线程池是在服务中配置的，在connector之间共享的。</strong>而且如果没有传递，会有一个默认的Executor(internalExecutor)在AbstractEndpoing类中供使用。</p>
<h2 id="首先一览众山小，介绍下tomcat架构中的几个组件">首先一览众山小，介绍下tomcat架构中的几个组件</h2><ul>
<li>Server  <em>服务器，web容器，Tomcat中最大的</em></li>
<li>Service <em>web容器能提供的服务</em></li>
<li>Connector <em>请求执行的通道，拿到新请求，扔给Container</em></li>
<li>Container <em>真正做事的地方，包含赫赫有名的四大组件</em><br>  1.Engine   <em>虚拟引擎</em><br>  2.Host     <em>虚拟主机</em><br>  3.Context  <em>web application</em><br>  4.Wrapper <em>servlet</em></li>
<li>Pipeline-Valve <em>责任链的完美诠释，各种StandardEngineValve，StandardHostValve，StandardContextValve，StandardWrpperValve</em></li>
<li>LifeCycle   <em>组件生命周期接口</em></li>
<li>JMX   <em>JavaBean动态管理</em></li>
<li>Realm  <em>权限模块</em></li>
</ul>
<p><strong>额外赠送serverStartupUML类图<a href="https://tomcat.apache.org/tomcat-8.0-doc/architecture/startup/serverStartup.pdf" target="_blank" rel="external">https://tomcat.apache.org/tomcat-8.0-doc/architecture/startup/serverStartup.pdf</a></strong><br>通过阅读此pdf，结合代码，总结一下tomcat在启动过程中需要做的几件事情：<br>1.加载配置文件catalina.properties<br>2.设置classLoader，从配置文件获取类的加载路径<br>3.利用classLoader，加载org.apache.catalina.startup.Catalina.<br>4.Catalina类加载，并解析servlet.xml</p>
<h2 id="休息一下，进入源码的解读">休息一下，进入源码的解读</h2><p>从标准的server开始<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Standard implementation of the &lt;b&gt;Server&lt;/b&gt; interface, available for use</span><br><span class="line"> * (but not required) when deploying and starting Catalina.</span><br><span class="line"> */</span></span><br><span class="line">public <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardServer</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">LifecycleMBeanBase</span> <span class="title">implements</span> <span class="title">Server</span> &#123;</span></span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span><br><span class="line">     * The set of Services associated with this Server.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Service</span> services[] = <span class="keyword">new</span> <span class="type">Service</span>[<span class="number">0</span>];<span class="comment">//当前Server拥有的Service</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> servicesLock = <span class="keyword">new</span> <span class="type">Object</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Add a new Service to the set of defined Services.</span><br><span class="line">     *</span><br><span class="line">     * @param service The Service to be added</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public void addService(<span class="type">Service</span> service) &#123;</span><br><span class="line">	......</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Standard implementation of the &lt;code&gt;Service&lt;/code&gt; interface.  The</span><br><span class="line"> * associated Container is generally an instance of Engine, but this is</span><br><span class="line"> * not required.</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">StandardService</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">LifecycleMBeanBase</span> <span class="title">implements</span> <span class="title">Service</span> &#123;</span></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * The &lt;code&gt;Server&lt;/code&gt; that owns this Service, if any.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Server</span> server = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span><br><span class="line">     * The set of Connectors associated with this Service.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Connector</span> connectors[] = <span class="keyword">new</span> <span class="type">Connector</span>[<span class="number">0</span>];<span class="comment">//当前Service拥有的Connector</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> connectorsLock = <span class="keyword">new</span> <span class="type">Object</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">ArrayList</span>&lt;<span class="type">Executor</span>&gt; executors = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;&gt;();<span class="comment">//这个服务配置的线程池，可在多个Connector之间共享</span></span><br><span class="line">    </span><br><span class="line">     <span class="comment">/**</span><br><span class="line">     * The Container associated with this Service.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Container</span> container = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上文提到的官方启动UML类图,我们先从Connector开始入手<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Implementation of a Coyote connector.</span><br><span class="line"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Connector</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">LifecycleMBeanBase</span>  &#123;</span></span><br><span class="line"></span><br><span class="line"> 	<span class="comment">/**</span><br><span class="line">     * Coyote Protocol handler class name.</span><br><span class="line">     * Defaults to the Coyote HTTP/1.1 protocolHandler.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">String</span> protocolHandlerClassName =</span><br><span class="line">        <span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>;</span><br><span class="line"></span><br><span class="line">  public <span class="type">Connector</span>(<span class="type">String</span> protocol) &#123;</span><br><span class="line">        setProtocol(protocol);</span><br><span class="line">        <span class="comment">// Instantiate protocol handler</span></span><br><span class="line">        <span class="type">ProtocolHandler</span> p = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span>&lt;?&gt; clazz = <span class="type">Class</span>.forName(protocolHandlerClassName);</span><br><span class="line">            p = (<span class="type">ProtocolHandler</span>) clazz.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">            log.error(sm.getString(</span><br><span class="line">                    <span class="string">"coyoteConnector.protocolHandlerInstantiationFailed"</span>), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.protocolHandler = p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="type">Globals</span>.<span class="type">STRICT_SERVLET_COMPLIANCE</span>) &#123;</span><br><span class="line">            <span class="type">URIEncoding</span> = <span class="string">"UTF-8"</span>;</span><br><span class="line">            <span class="type">URIEncodingLower</span> = <span class="type">URIEncoding</span>.toLowerCase(<span class="type">Locale</span>.<span class="type">ENGLISH</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Coyote protocol handler.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">ProtocolHandler</span> protocolHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void initInternal() <span class="keyword">throws</span> <span class="type">LifecycleException</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.initInternal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize adapter</span></span><br><span class="line">        adapter = <span class="keyword">new</span> <span class="type">CoyoteAdapter</span>(<span class="keyword">this</span>);</span><br><span class="line">        protocolHandler.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure parseBodyMethodsSet has a default</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="literal">null</span> == parseBodyMethodsSet ) &#123;</span><br><span class="line">            setParseBodyMethods(getParseBodyMethods());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (protocolHandler.isAprRequired() &amp;&amp;</span><br><span class="line">                !<span class="type">AprLifecycleListener</span>.isAprAvailable()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">LifecycleException</span>(</span><br><span class="line">                    sm.getString(<span class="string">"coyoteConnector.protocolHandlerNoApr"</span>,</span><br><span class="line">                            getProtocolHandlerClassName()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            protocolHandler.init();<span class="comment">//方法核心ProtocolHandler.init</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">LifecycleException</span></span><br><span class="line">                (sm.getString</span><br><span class="line">                 (<span class="string">"coyoteConnector.protocolHandlerInitializationFailed"</span>), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Begin processing requests via this Connector.</span><br><span class="line">     *</span><br><span class="line">     * @exception LifecycleException if a fatal startup error occurs</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void startInternal() <span class="keyword">throws</span> <span class="type">LifecycleException</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate settings before starting</span></span><br><span class="line">        <span class="keyword">if</span> (getPort() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">LifecycleException</span>(sm.getString(</span><br><span class="line">                    <span class="string">"coyoteConnector.invalidPort"</span>, <span class="type">Integer</span>.valueOf(getPort())));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setState(<span class="type">LifecycleState</span>.<span class="type">STARTING</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            protocolHandler.start();<span class="comment">//方法核心ProtocolHandler.start</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">            <span class="type">String</span> errPrefix = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.service != <span class="literal">null</span>) &#123;</span><br><span class="line">                errPrefix += <span class="string">"service.getName(): \""</span> + <span class="keyword">this</span>.service.getName() + <span class="string">"\"; "</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">LifecycleException</span></span><br><span class="line">                (errPrefix + <span class="string">" "</span> + sm.getString</span><br><span class="line">                 (<span class="string">"coyoteConnector.protocolHandlerStartFailed"</span>), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ProtocolHandler是干嘛的，接着跟代码<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Abstract the protocol implementation, including threading, etc.</span><br><span class="line"> * Processor is single threaded and specific to stream-based protocols,</span><br><span class="line"> * will not fit Jk protocols like JNI.</span><br><span class="line"> *</span><br><span class="line"> * This is the main interface to be implemented by a coyote connector.</span><br><span class="line"> * Adapter is the main interface to be implemented by a coyote servlet</span><br><span class="line"> * container.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ProtocolHandler</span> &#123;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">/**</span><br><span class="line">     * The adapter, used to call the connector.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span>(<span class="params">Adapter adapter</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The executor, provide access to the underlying thread pool.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这边走到头了，返回上个类Connector，定位到protocolHandlerClassName = “org.apache.coyote.http11.Http11NioProtocol”，我们来看看Http11NioProtocol<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Abstract the protocol implementation, including threading, etc.</span><br><span class="line"> * Processor is single threaded and specific to stream-based protocols,</span><br><span class="line"> * will not fit Jk protocols like JNI.</span><br><span class="line"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Http11NioProtocol</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractHttp11JsseProtocol&lt;NioChannel&gt;</span> &#123;</span></span><br><span class="line">  public <span class="type">Http11NioProtocol</span>() &#123;</span><br><span class="line">        endpoint=<span class="keyword">new</span> <span class="type">NioEndpoint</span>();<span class="comment">//核心代码</span></span><br><span class="line">        cHandler = <span class="keyword">new</span> <span class="type">Http11ConnectionHandler</span>(<span class="keyword">this</span>);<span class="comment">//核心代码</span></span><br><span class="line">        ((<span class="type">NioEndpoint</span>) endpoint).setHandler(cHandler);</span><br><span class="line">        setSoLinger(<span class="type">Constants</span>.<span class="type">DEFAULT_CONNECTION_LINGER</span>);</span><br><span class="line">        setSoTimeout(<span class="type">Constants</span>.<span class="type">DEFAULT_CONNECTION_TIMEOUT</span>);</span><br><span class="line">        setTcpNoDelay(<span class="type">Constants</span>.<span class="type">DEFAULT_TCP_NO_DELAY</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过构造函数发现，在Http11NioProtocol中使用的是NioEndpoint，为这个endpoint指定的Handler是Http11ConnectionHandler类型。继续追踪父类<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHttp11JsseProtocol</span>&lt;<span class="title">S</span>&gt;</span><br><span class="line">        <span class="keyword">extends</span> <span class="title">AbstractHttp11Protocol</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不是不写注释，源码中并未添加对这个类的注解，可见这个类也不是核心，查看代码可知基本是setter和getter，接着跟<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHttp11Protocol&lt;S&gt;</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractProtocol&lt;S&gt;</span> &#123;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractProtocol</span>&lt;<span class="title">S</span>&gt; <span class="keyword">implements</span> <span class="title">ProtocolHandler</span>,</span><br><span class="line">        <span class="title">MBeanRegistration</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Endpoint that provides low-level network I/O - must be matched to the</span><br><span class="line">     * ProtocolHandler implementation (ProtocolHandler using BIO, requires BIO</span><br><span class="line">     * Endpoint etc.).</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> AbstractEndpoint&lt;S&gt; endpoint = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The adapter provides the link between the ProtocolHandler and the</span><br><span class="line">     * connector.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Adapter adapter;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> MBeanServer mserver;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// ------------------------------------------------------- Lifecycle methods</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * <span class="doctag">NOTE:</span> There is no maintenance of state or checking for valid transitions</span><br><span class="line">     * within this class. It is expected that the connector will maintain state</span><br><span class="line">     * and prevent invalid state transitions.</span><br><span class="line">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getLog().isInfoEnabled())</span><br><span class="line">            getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.init"</span>,</span><br><span class="line">                    getName()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oname == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Component not pre-registered so register it</span></span><br><span class="line">            oname = createObjectName();</span><br><span class="line">            <span class="keyword">if</span> (oname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(<span class="keyword">this</span>, oname,</span><br><span class="line">                    <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.domain != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                tpOname = <span class="keyword">new</span> ObjectName(domain + <span class="string">":"</span> +</span><br><span class="line">                        <span class="string">"type=ThreadPool,name="</span> + getName());</span><br><span class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(endpoint,</span><br><span class="line">                        tpOname, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                getLog().<span class="keyword">error</span>(sm.getString(</span><br><span class="line">                        <span class="string">"abstractProtocolHandler.mbeanRegistrationFailed"</span>,</span><br><span class="line">                        tpOname, getName()), e);</span><br><span class="line">            &#125;</span><br><span class="line">            rgOname=<span class="keyword">new</span> ObjectName(domain +</span><br><span class="line">                    <span class="string">":type=GlobalRequestProcessor,name="</span> + getName());</span><br><span class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(</span><br><span class="line">                    getHandler().getGlobal(), rgOname, <span class="keyword">null</span> );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String endpointName = getName();</span><br><span class="line">        endpoint.setName(endpointName.substring(<span class="number">1</span>, endpointName.length()-<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            endpoint.init();<span class="comment">//核心代码，endpoint.init</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            getLog().<span class="keyword">error</span>(sm.getString(<span class="string">"abstractProtocolHandler.initError"</span>,</span><br><span class="line">                    getName()), ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getLog().isInfoEnabled())</span><br><span class="line">            getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.start"</span>,</span><br><span class="line">                    getName()));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            endpoint.start();<span class="comment">//核心代码，endpoint.start</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            getLog().<span class="keyword">error</span>(sm.getString(<span class="string">"abstractProtocolHandler.startError"</span>,</span><br><span class="line">                    getName()), ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码上看AbstractProtocol本身并不做太多请求解析处理相关的事情，它是把事情委托给了一个AbstractEndpoint对象来完成。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractEndpoint</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * counter for nr of connections handled by an endpoint</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> LimitLatch connectionLimitLatch = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Threads used to accept new connections and pass them to worker threads.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Acceptor[] acceptors;<span class="comment">//意义很明确，接收新链接，扔给工作线程去执行。</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//典型的模板方法，从createAcceptor()由子类去实现可以看出。骨架+钩子函数</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startAcceptorThreads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = getAcceptorThreadCount();</span><br><span class="line">        acceptors = <span class="keyword">new</span> Acceptor[count];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            acceptors[i] = createAcceptor();<span class="comment">//核心</span></span><br><span class="line">            String threadName = getName() + <span class="string">"-Acceptor-"</span> + i;</span><br><span class="line">            acceptors[i].setThreadName(threadName);</span><br><span class="line">            Thread t = <span class="keyword">new</span> Thread(acceptors[i], threadName);</span><br><span class="line">            t.setPriority(getAcceptorThreadPriority());</span><br><span class="line">            t.setDaemon(getDaemon());<span class="comment">//true 守护线程</span></span><br><span class="line">            t.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Hook to allow Endpoints to provide a specific Acceptor implementation.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Acceptor <span class="title">createAcceptor</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxConnections = <span class="number">10000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Are we using an internal executor</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> internalExecutor = <span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * External Executor based thread pool.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> Executor executor = <span class="keyword">null</span>;<span class="comment">//此线程池可由外部指定，如果外部不指定，则由AbstractEndpoint自己来创建。由参数internalExecutor决定</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExecutor</span><span class="params">(Executor executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.executor = executor;</span><br><span class="line">        <span class="keyword">this</span>.internalExecutor = (executor == <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> executor; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//AbstractEndpoint自己创建线程池的实现方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        internalExecutor = <span class="keyword">true</span>;</span><br><span class="line">        TaskQueue taskqueue = <span class="keyword">new</span> TaskQueue();</span><br><span class="line">        TaskThreadFactory tf = <span class="keyword">new</span> TaskThreadFactory(getName() + <span class="string">"-exec-"</span>, daemon, getThreadPriority());</span><br><span class="line">        executor = <span class="keyword">new</span> ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), <span class="number">60</span>, TimeUnit.SECONDS,taskqueue, tf);</span><br><span class="line">        taskqueue.setParent( (ThreadPoolExecutor) executor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Allows the server developer to specify the backlog that</span><br><span class="line">     * should be used for server sockets. By default, this value</span><br><span class="line">     * is 100.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> backlog = <span class="number">100</span>;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">   <span class="comment">// ------------------------------------------------------- Lifecycle methods</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * <span class="doctag">NOTE:</span> There is no maintenance of state or checking for valid transitions</span><br><span class="line">     * within this class other than ensuring that bind/unbind are called in the</span><br><span class="line">     * right place. It is expected that the calling code will maintain state and</span><br><span class="line">     * prevent invalid state transitions.</span><br><span class="line">     */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        testServerCipherSuitesOrderSupport();</span><br><span class="line">        <span class="keyword">if</span> (bindOnInit) &#123;</span><br><span class="line">            bind();</span><br><span class="line">            bindState = BindState.BOUND_ON_INIT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bindState == BindState.UNBOUND) &#123;</span><br><span class="line">            bind();</span><br><span class="line">            bindState = BindState.BOUND_ON_START;</span><br><span class="line">        &#125;</span><br><span class="line">        startInternal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在Http11NioProtocol的构造函数中指定的是使用NioEndpoint实例，因此这里通过分析AbstractEndpoint的子类NioEndpoint来做进一步的了解。这个是个加工厂，用于组装<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * NIO tailored thread pool, providing the following services:</span><br><span class="line"> * &lt;ul&gt;</span><br><span class="line"> * &lt;li&gt;Socket acceptor thread&lt;/li&gt;</span><br><span class="line"> * &lt;li&gt;Socket poller thread&lt;/li&gt;</span><br><span class="line"> * &lt;li&gt;Worker threads pool&lt;/li&gt;</span><br><span class="line"> * &lt;/ul&gt;</span><br><span class="line"> *</span><br><span class="line"> * When switching to Java 5, there's an opportunity to use the virtual</span><br><span class="line"> * machine's thread pool.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioEndpoint</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span>&lt;<span class="title">NioChannel</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --------------------------------------------------- Acceptor Inner Class</span></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The background thread that listens for incoming TCP/IP connections and</span><br><span class="line">     * hands them off to an appropriate processor.</span><br><span class="line">     * Acceptor负责接收网络请求，建立连接。连接建立之后，将这个socket连接交给Poller。由Poller来负责执行数据的读取和业务执行</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span>.<span class="title">Acceptor</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">/**</span><br><span class="line">     * Process the specified connection.</span><br><span class="line">     * setSocketOptions方法是专门处理特定socket连接的方法，将一个SocketChannel对象包装成一个NioChannel之后，注册到Poller中</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">boolean</span> <span class="title">setSocketOptions</span><span class="params">(SocketChannel socket)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Process the connection</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//disable blocking, APR style, we are gonna be polling it</span></span><br><span class="line">            socket.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            Socket sock = socket.socket();</span><br><span class="line">            socketProperties.setProperties(sock);</span><br><span class="line"></span><br><span class="line">            NioChannel channel = nioChannels.pop();</span><br><span class="line">            <span class="keyword">if</span> ( channel == <span class="keyword">null</span> ) &#123;</span><br><span class="line">                <span class="comment">// SSL setup</span></span><br><span class="line">                <span class="keyword">if</span> (sslContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// normal tcp setup</span></span><br><span class="line">                    NioBufferHandler bufhandler = <span class="keyword">new</span> NioBufferHandler(socketProperties.getAppReadBufSize(),</span><br><span class="line">                                                                       socketProperties.getAppWriteBufSize(),</span><br><span class="line">                                                                       socketProperties.getDirectBuffer());</span><br><span class="line"></span><br><span class="line">                    channel = <span class="keyword">new</span> NioChannel(socket, bufhandler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                channel.setIOChannel(socket);</span><br><span class="line">                <span class="keyword">if</span> ( channel <span class="keyword">instanceof</span> SecureNioChannel ) &#123;</span><br><span class="line">                    SSLEngine engine = createSSLEngine();</span><br><span class="line">                    ((SecureNioChannel)channel).reset(engine);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    channel.reset();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            getPoller0().register(channel);<span class="comment">//注册</span></span><br><span class="line">            <span class="comment">//getPoller0是从在startInternal方法中初始化的pollsers数组中取一个poller。然后通过Poller对象的register方法把这个channel注册到此Poller对象上。pollers数组的大小是根据当前的运行环境计算出来的，无法通过配置修改。</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.<span class="keyword">error</span>(<span class="string">""</span>,t);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable tt) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Tell to close the socket</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">/**</span><br><span class="line">     * Return an available poller in true round robin fashion 轮训调度方式</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Poller <span class="title">getPoller0</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> idx = Math.abs(pollerRotater.incrementAndGet()) % pollers.length;</span><br><span class="line">        <span class="keyword">return</span> pollers[idx];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Poller class.</span><br><span class="line">     * 初始化pollers数组，同时启动pollers数组中的线程，让pollers开始工作。</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poller</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">     <span class="keyword">private</span> Selector selector;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> SynchronizedQueue&lt;PollerEvent&gt; events =</span><br><span class="line">                <span class="keyword">new</span> SynchronizedQueue&lt;&gt;();<span class="comment">//PollerEvent完成channel对selector的事件注册，具体可见代码</span></span><br><span class="line">     </span><br><span class="line">     <span class="comment">/**</span><br><span class="line">         * The background thread that listens for incoming TCP/IP connections and</span><br><span class="line">         * hands them off to an appropriate processor.</span><br><span class="line">         */</span></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Loop until destroy() is called</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Loop if endpoint is paused</span></span><br><span class="line">                    <span class="keyword">while</span> (paused &amp;&amp; (!close) ) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            <span class="comment">// Ignore</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">boolean</span> hasEvents = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Time to terminate?</span></span><br><span class="line">                    <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                        events();</span><br><span class="line">                        timeout(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            selector.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                            log.<span class="keyword">error</span>(sm.getString(</span><br><span class="line">                                    <span class="string">"endpoint.nio.selectorCloseFail"</span>), ioe);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        hasEvents = events();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( !close ) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (wakeupCounter.getAndSet(-<span class="number">1</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="comment">//if we are here, means we have other stuff to do</span></span><br><span class="line">                                <span class="comment">//do a non blocking select</span></span><br><span class="line">                                keyCount = selector.selectNow();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                keyCount = selector.select(selectorTimeout);</span><br><span class="line">                            &#125;</span><br><span class="line">                            wakeupCounter.set(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                            events();</span><br><span class="line">                            timeout(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                selector.close();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                                log.<span class="keyword">error</span>(sm.getString(</span><br><span class="line">                                        <span class="string">"endpoint.nio.selectorCloseFail"</span>), ioe);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                        ExceptionUtils.handleThrowable(x);</span><br><span class="line">                        log.<span class="keyword">error</span>(<span class="string">""</span>,x);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//either we timed out or we woke up, process events first</span></span><br><span class="line">                    <span class="keyword">if</span> ( keyCount == <span class="number">0</span> ) hasEvents = (hasEvents | events());</span><br><span class="line"><span class="comment">//正常状态下的数据处理，通过processKey来实现。获取对应的渠道的key，然后调用processKey方法</span></span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iterator =</span><br><span class="line">                        keyCount &gt; <span class="number">0</span> ? selector.selectedKeys().iterator() : <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">// Walk through the collection of ready keys and dispatch</span></span><br><span class="line">                    <span class="comment">// any active event.</span></span><br><span class="line">                    <span class="keyword">while</span> (iterator != <span class="keyword">null</span> &amp;&amp; iterator.hasNext()) &#123;</span><br><span class="line">                        SelectionKey sk = iterator.next();</span><br><span class="line">                        KeyAttachment attachment = (KeyAttachment)sk.attachment();</span><br><span class="line">                        <span class="comment">// Attachment may be null if another thread has called</span></span><br><span class="line">                        <span class="comment">// cancelledKey()</span></span><br><span class="line">                        <span class="keyword">if</span> (attachment == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            iterator.remove();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            attachment.access();</span><br><span class="line">                            iterator.remove();</span><br><span class="line">                            processKey(sk, attachment);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="comment">//while</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//process timeouts</span></span><br><span class="line">                    timeout(keyCount,hasEvents);</span><br><span class="line">                    <span class="keyword">if</span> ( oomParachute &gt; <span class="number">0</span> &amp;&amp; oomParachuteData == <span class="keyword">null</span> ) checkParachute();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (OutOfMemoryError oom) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        oomParachuteData = <span class="keyword">null</span>;</span><br><span class="line">                        releaseCaches();</span><br><span class="line">                        log.<span class="keyword">error</span>(<span class="string">""</span>, oom);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> ( Throwable oomt ) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            System.err.println(oomParachuteMsg);</span><br><span class="line">                            oomt.printStackTrace();</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (Throwable letsHopeWeDontGetHere)&#123;</span><br><span class="line">                            ExceptionUtils.handleThrowable(letsHopeWeDontGetHere);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="comment">//while</span></span><br><span class="line"></span><br><span class="line">            stopLatch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//processKey的主要工作是调用NioEndpoint的processSocket来实现socket的读写</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="function"><span class="keyword">boolean</span> <span class="title">processKey</span><span class="params">(SelectionKey sk, KeyAttachment attachment)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> ( isWorkerAvailable() ) &#123;</span><br><span class="line">                                unreg(sk, attachment, sk.readyOps());</span><br><span class="line">                                <span class="keyword">boolean</span> closeSocket = <span class="keyword">false</span>;</span><br><span class="line">                                <span class="comment">// Read goes before write</span></span><br><span class="line">                                <span class="keyword">if</span> (sk.isReadable()) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (!processSocket(attachment, SocketStatus.OPEN_READ, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                                        closeSocket = <span class="keyword">true</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (!closeSocket &amp;&amp; sk.isWritable()) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (!processSocket(attachment, SocketStatus.OPEN_WRITE, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                                        closeSocket = <span class="keyword">true</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (closeSocket) &#123;</span><br><span class="line">                                    cancelledKey(sk,SocketStatus.DISCONNECT);</span><br><span class="line">                                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">boolean</span> <span class="title">processSocket</span><span class="params">(KeyAttachment attachment, SocketStatus status, <span class="keyword">boolean</span> dispatch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (attachment == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            SocketProcessor sc = processorCache.pop();</span><br><span class="line">            <span class="keyword">if</span> ( sc == <span class="keyword">null</span> ) sc = <span class="keyword">new</span> SocketProcessor(attachment, status);</span><br><span class="line">            <span class="function"><span class="keyword">else</span> sc.<span class="title">reset</span><span class="params">(attachment, status)</span></span>;</span><br><span class="line">            Executor executor = getExecutor();<span class="comment">//使用线程池--整个的流程client-&gt;Acceptor-&gt;Poller-&gt;Socket Processor（Executor）</span></span><br><span class="line">            <span class="keyword">if</span> (dispatch &amp;&amp; executor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                executor.execute(sc);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sc.run();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RejectedExecutionException ree) &#123;</span><br><span class="line">            log.warn(sm.getString(<span class="string">"endpoint.executor.fail"</span>, attachment.getSocket()), ree);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            <span class="comment">// This means we got an OOM or similar creating a thread, or that</span></span><br><span class="line">            <span class="comment">// the pool and its queue are full</span></span><br><span class="line">            log.<span class="keyword">error</span>(sm.getString(<span class="string">"endpoint.process.fail"</span>), t);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ---------------------------------------------- SocketProcessor Inner Class</span></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * This class is the equivalent of the Worker, but will simply use in an</span><br><span class="line">     * external Executor thread pool.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Initialize the endpoint.监听端口</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        serverSock = ServerSocketChannel.open();</span><br><span class="line">        socketProperties.setProperties(serverSock.socket());</span><br><span class="line">        InetSocketAddress addr = (getAddress()!=<span class="keyword">null</span>?<span class="keyword">new</span> InetSocketAddress(getAddress(),getPort()):<span class="keyword">new</span> InetSocketAddress(getPort()));</span><br><span class="line">        serverSock.socket().bind(addr,getBacklog());</span><br><span class="line">        serverSock.configureBlocking(<span class="keyword">true</span>); <span class="comment">//mimic APR behavior</span></span><br><span class="line">        serverSock.socket().setSoTimeout(getSocketProperties().getSoTimeout());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize thread count defaults for acceptor, poller</span></span><br><span class="line">        <span class="keyword">if</span> (acceptorThreadCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">FIXME:</span> Doesn't seem to work that well with multiple accept threads</span></span><br><span class="line">            acceptorThreadCount = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pollerThreadCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//minimum one poller thread</span></span><br><span class="line">            pollerThreadCount = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        stopLatch = <span class="keyword">new</span> CountDownLatch(pollerThreadCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize SSL if needed</span></span><br><span class="line">        <span class="keyword">if</span> (isSSLEnabled()) &#123;</span><br><span class="line">           ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oomParachute&gt;<span class="number">0</span>) reclaimParachute(<span class="keyword">true</span>);</span><br><span class="line">        selectorPool.open();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Start the NIO endpoint, creating acceptor, poller threads.</span><br><span class="line">     * 初始化线程池，创建和启动网络数据接收线程组，创建和启动poller线程组</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">            running = <span class="keyword">true</span>;</span><br><span class="line">            paused = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            processorCache = <span class="keyword">new</span> SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                    socketProperties.getProcessorCache());</span><br><span class="line">            eventCache = <span class="keyword">new</span> SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                            socketProperties.getEventCache());</span><br><span class="line">            nioChannels = <span class="keyword">new</span> SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                    socketProperties.getBufferPool());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create worker collection</span></span><br><span class="line">            <span class="keyword">if</span> ( getExecutor() == <span class="keyword">null</span> ) &#123;</span><br><span class="line">                createExecutor();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            initializeConnectionLatch();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start poller threads</span></span><br><span class="line">            pollers = <span class="keyword">new</span> Poller[getPollerThreadCount()];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;pollers.length; i++) &#123;</span><br><span class="line">                pollers[i] = <span class="keyword">new</span> Poller();</span><br><span class="line">                Thread pollerThread = <span class="keyword">new</span> Thread(pollers[i], getName() + <span class="string">"-ClientPoller-"</span>+i);</span><br><span class="line">                pollerThread.setPriority(threadPriority);</span><br><span class="line">                pollerThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">                pollerThread.start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            startAcceptorThreads();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总结一下：<br>[Acceptor]：<br>     负责监听并接收socket连接建立。由Acceptor来控制与服务端建立连接的客户端socket数目。具体的数目为一个服务可配置项，可以在启动服务时指定.默认的配置在AbstractEndpoint中，初始值为10000</p>
<p>[Poller]：<br>     负责处理已建立连接的socket，将channel封装后，提交至线程池（Executors）来处理。Poller线程的数目与运行时环境有关，通过计算得出，不可配置。</p>
<p>[Executors]：<br>     处理socket请求的线程池。线程池中线程的数目可在启动服务时配置。<br>socket.getPoller()返回这个channel所注册的Poller对象。getSelector()返回这个Poller对象的selector。注册之后，当这个socket的channel有数据到达，便能通过selector.select活selector.selectNow被返回，放入到Executor中进行处理。</p>
<p>继续<br>在Http11NioProtocol构造函数中有个Http11ConnectionHandler我们还没分析，下面来看看。<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --------------------  Connection handler --------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Http11ConnectionHandler</span></span><br><span class="line">            <span class="keyword">extends</span> <span class="title">AbstractConnectionHandler</span>&lt;<span class="title">Long</span>,<span class="title">Http11AprProcessor</span>&gt; <span class="keyword">implements</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> Http11AprProtocol proto;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Processes HTTP requests.</span><br><span class="line"> *</span><br><span class="line"> * @author Remy Maucherat</span><br><span class="line"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Http11AprProcessor</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractHttp11Processor&lt;Long&gt;</span> &#123;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getAdapter().service(request, response);，用于处理用户自定义Servlet请求的地方<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> abstract <span class="keyword">class</span> AbstractHttp11Processor&lt;S&gt; extends AbstractProcessor&lt;S&gt; &#123;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * Process pipelined HTTP requests using the specified input and output</span><br><span class="line">     * streams.</span><br><span class="line">     *</span><br><span class="line">     * @param socketWrapper Socket from which the HTTP requests will be read</span><br><span class="line">     *               and the HTTP responses will be written.</span><br><span class="line">     *</span><br><span class="line">     * @throws IOException error during an I/O operation</span><br><span class="line">     */</span></span><br><span class="line">    @<span class="function">Override</span><br><span class="line">    <span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; socketWrapper)</span></span><br><span class="line">        throws IOException </span>&#123;</span><br><span class="line">        RequestInfo rp = request.getRequestProcessor();</span><br><span class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_PARSE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Setting up the I/O</span></span><br><span class="line">        setSocketWrapper(socketWrapper);</span><br><span class="line">        getInputBuffer().init(socketWrapper, endpoint);</span><br><span class="line">        getOutputBuffer().init(socketWrapper, endpoint);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Flags</span></span><br><span class="line">        keepAlive = <span class="literal">true</span>;</span><br><span class="line">        comet = <span class="literal">false</span>;</span><br><span class="line">        openSocket = <span class="literal">false</span>;</span><br><span class="line">        sendfileInProgress = <span class="literal">false</span>;</span><br><span class="line">        readComplete = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (endpoint.getUsePolling()) &#123;</span><br><span class="line">            keptAlive = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            keptAlive = socketWrapper.isKeptAlive();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (disableKeepAlive()) &#123;</span><br><span class="line">            socketWrapper.setKeepAliveLeft(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!getErrorState().isError() &amp;&amp; keepAlive &amp;&amp; !comet &amp;&amp; !isAsync() &amp;&amp;</span><br><span class="line">                httpUpgradeHandler == null &amp;&amp; !endpoint.isPaused()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Parsing the request header</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                setRequestLineReadTimeout();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!getInputBuffer().parseRequestLine(keptAlive)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (handleIncompleteRequestLineRead()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (endpoint.isPaused()) &#123;</span><br><span class="line">                    <span class="comment">// 503 - Service unavailable</span></span><br><span class="line">                    response.setStatus(<span class="number">503</span>);</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, null);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    keptAlive = <span class="literal">true</span>;</span><br><span class="line">                    <span class="comment">// Set this every time in case limit has been changed via JMX</span></span><br><span class="line">                    request.getMimeHeaders().setLimit(endpoint.getMaxHeaderCount());</span><br><span class="line">                    <span class="comment">// Currently only NIO will ever return false here</span></span><br><span class="line">                    <span class="keyword">if</span> (!getInputBuffer().parseHeaders()) &#123;</span><br><span class="line">                        <span class="comment">// We've read part of the request, don't recycle it</span></span><br><span class="line">                        <span class="comment">// instead associate it with the socket</span></span><br><span class="line">                        openSocket = <span class="literal">true</span>;</span><br><span class="line">                        readComplete = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!disableUploadTimeout) &#123;</span><br><span class="line">                        setSocketTimeout(connectionUploadTimeout);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                    getLog().debug(</span><br><span class="line">                            sm.getString(<span class="string">"http11processor.header.parse"</span>), e);</span><br><span class="line">                &#125;</span><br><span class="line">                setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                UserDataHelper.Mode logMode = userDataHelper.getNextMode();</span><br><span class="line">                <span class="keyword">if</span> (logMode != null) &#123;</span><br><span class="line">                    String message = sm.getString(</span><br><span class="line">                            <span class="string">"http11processor.header.parse"</span>);</span><br><span class="line">                    <span class="keyword">switch</span> (logMode) &#123;</span><br><span class="line">                        <span class="keyword">case</span> INFO_THEN_DEBUG:</span><br><span class="line">                            message += sm.getString(</span><br><span class="line">                                    <span class="string">"http11processor.fallToDebug"</span>);</span><br><span class="line">                            <span class="comment">//$FALL-THROUGH$</span></span><br><span class="line">                        <span class="keyword">case</span> INFO:</span><br><span class="line">                            getLog().info(message);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> DEBUG:</span><br><span class="line">                            getLog().debug(message);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 400 - Bad Request</span></span><br><span class="line">                response.setStatus(<span class="number">400</span>);</span><br><span class="line">                setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                getAdapter().<span class="built_in">log</span>(request, response, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!getErrorState().isError()) &#123;</span><br><span class="line">                <span class="comment">// Setting up filters, and parse some request headers</span></span><br><span class="line">                rp.setStage(org.apache.coyote.Constants.STAGE_PREPARE);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    prepareRequest();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                        getLog().debug(sm.getString(</span><br><span class="line">                                <span class="string">"http11processor.request.prepare"</span>), t);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 500 - Internal Server Error</span></span><br><span class="line">                    response.setStatus(<span class="number">500</span>);</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                    getAdapter().<span class="built_in">log</span>(request, response, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (maxKeepAliveRequests == <span class="number">1</span>) &#123;</span><br><span class="line">                keepAlive = <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxKeepAliveRequests &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    socketWrapper.decrementKeepAlive() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                keepAlive = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process the request in the adapter</span></span><br><span class="line">            <span class="keyword">if</span> (!getErrorState().isError()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    rp.setStage(org.apache.coyote.Constants.STAGE_SERVICE);</span><br><span class="line">                    getAdapter().service(request, response);<span class="comment">//核心代码</span></span><br><span class="line">                    <span class="comment">// Handle when the response was committed before a serious</span></span><br><span class="line">                    <span class="comment">// error occurred.  Throwing a ServletException should both</span></span><br><span class="line">                    <span class="comment">// set the status to 500 and set the errorException.</span></span><br><span class="line">                    <span class="comment">// If we fail here, then the response is likely already</span></span><br><span class="line">                    <span class="comment">// committed, so we can't try and set headers.</span></span><br><span class="line">                    <span class="keyword">if</span>(keepAlive &amp;&amp; !getErrorState().isError() &amp;&amp; (</span><br><span class="line">                            response.getErrorException() != null ||</span><br><span class="line">                                    (!isAsync() &amp;&amp;</span><br><span class="line">                                    statusDropsConnection(response.getStatus())))) &#123;</span><br><span class="line">                        setErrorState(ErrorState.CLOSE_CLEAN, null);</span><br><span class="line">                    &#125;</span><br><span class="line">                    setCometTimeouts(socketWrapper);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedIOException e) &#123;</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (HeadersTooLargeException e) &#123;</span><br><span class="line">                    <span class="comment">// The response should not have been committed but check it</span></span><br><span class="line">                    <span class="comment">// anyway to be safe</span></span><br><span class="line">                    <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">                        setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        response.reset();</span><br><span class="line">                        response.setStatus(<span class="number">500</span>);</span><br><span class="line">                        setErrorState(ErrorState.CLOSE_CLEAN, e);</span><br><span class="line">                        response.setHeader(<span class="string">"Connection"</span>, <span class="string">"close"</span>); <span class="comment">// <span class="doctag">TODO:</span> Remove</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    getLog().error(sm.getString(</span><br><span class="line">                            <span class="string">"http11processor.request.process"</span>), t);</span><br><span class="line">                    <span class="comment">// 500 - Internal Server Error</span></span><br><span class="line">                    response.setStatus(<span class="number">500</span>);</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                    getAdapter().<span class="built_in">log</span>(request, response, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Finish the handling of the request</span></span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDINPUT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet) &#123;</span><br><span class="line">                <span class="keyword">if</span> (getErrorState().isError()) &#123;</span><br><span class="line">                    <span class="comment">// If we know we are closing the connection, don't drain</span></span><br><span class="line">                    <span class="comment">// input. This way uploading a 100GB file doesn't tie up the</span></span><br><span class="line">                    <span class="comment">// thread if the servlet has rejected it.</span></span><br><span class="line">                    getInputBuffer().setSwallowInput(<span class="literal">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Need to check this again here in case the response was</span></span><br><span class="line">                    <span class="comment">// committed before the error that requires the connection</span></span><br><span class="line">                    <span class="comment">// to be closed occurred.</span></span><br><span class="line">                    checkExpectationAndResponseStatus();</span><br><span class="line">                &#125;</span><br><span class="line">                endRequest();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDOUTPUT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If there was an error, make sure the request is counted as</span></span><br><span class="line">            <span class="comment">// and error, and update the statistics counter</span></span><br><span class="line">            <span class="keyword">if</span> (getErrorState().isError()) &#123;</span><br><span class="line">                response.setStatus(<span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet || getErrorState().isError()) &#123;</span><br><span class="line">                request.updateCounters();</span><br><span class="line">                <span class="keyword">if</span> (getErrorState().isIoAllowed()) &#123;</span><br><span class="line">                    getInputBuffer().nextRequest();</span><br><span class="line">                    getOutputBuffer().nextRequest();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!disableUploadTimeout) &#123;</span><br><span class="line">                <span class="keyword">if</span>(endpoint.getSoTimeout() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    setSocketTimeout(endpoint.getSoTimeout());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    setSocketTimeout(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (breakKeepAliveLoop(socketWrapper)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getErrorState().isError() || endpoint.isPaused()) &#123;</span><br><span class="line">            <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isAsync() || comet) &#123;</span><br><span class="line">            <span class="keyword">return</span> SocketState.LONG;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUpgrade()) &#123;</span><br><span class="line">            <span class="keyword">return</span> SocketState.UPGRADING;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sendfileInProgress) &#123;</span><br><span class="line">                <span class="keyword">return</span> SocketState.SENDFILE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (openSocket) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (readComplete) &#123;</span><br><span class="line">                        <span class="keyword">return</span> SocketState.OPEN;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> SocketState.LONG;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终执行代码的adapter是来自于AbstractHttp11Protocol。还记得在Connector的startInternal函数么，在那里使用的是protocolHandler就是org.apache.coyote.http11.Http11NioProtocol，它继承了AbstractHttp11Protocol，所以这个最终的adapter是来自Http11NioProtocol的setAdapter方法传递进来。而这个方法，在Connector的initInternal中被调用，并且实际上就是这个Connector对象本身。</p>
<p>总结一下Tomcat中的几个核心模块<br><strong>[Acceptor]</strong><br>负责用来管理连接到tomcat服务器的数量，来看看Acceptor在tomcat服务器中的应用，是如何实现连接管理的，socket连接建立成功之后，是如何实现内容的读写的（读写是交由Poller机制去完成）。</p>
<p><strong>[连接的传递]</strong><br>管理连接的建立差不多就是Acceptor的主要工作了，连接建立好之后，最后的工作就是交给Poller去实现数据的读写。在setSocketOptions中实现了SocketChannel对Poller的注册。</p>
<p><strong>[Connection Handler]</strong><br>处理socket连接的handler<br>content:  Http11ConnectionHandler、AbstractConnectionHandler、AbstractEndpoint.Handler<br>主要内容部分在AbstractConnectionHandler上，从在这个类中定义的方法上和成员变量上可以看出，它作为一个Handler，但实际上并不直接对socket进行处理。它的主要作用是提供了将Processor和connection进行关联的地方，在适合的地方调用Processor去处理connection。还一个作用是在ConnectionHandler中维护内部缓存来提升系统性能。</p>
<p>在AbstractConnectionHandler的process方法中，实现了对socket的状态检查，缓存数据读写等操作。虽然是在这里对socket进行了各种检查，但并不涉及socket数据的处理，对socket的实际处理，还是交给了Processor来完成。</p>
<p>通过抽象方法 createProcessor方法，来作为关联Processor的入口。通过getProtocol方法，来作为获取和此Connection Handler关联的protocol的入口。</p>
<p><strong>[Socket Processor]</strong><br>处理socket数据<br>content: Http11Processor、AbstractHttp11Processor、org.apache.coyote.AbstractProcessor、org.apache.coyote.Processor</p>
<p>Socket Processor是具体处理socket，读写socket数据的地方。</p>
<p>最上层的Processor接口定义了getExecutor、process、event、getRequest等接口，定义了socket processor的大致模型。<br>     getExecutor方法定义了获取处理socket的线程池入口<br>     process方法是处理socket的入口<br>     event处理socket事件的地方<br>     request获取请求来源的入口<br>次一层的AbstractProcessor定义了Socket Processor框架和其它模块的交互关系，从AbstractProcessor的属性中可以看出<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractProcessor</span>&lt;<span class="title">S</span>&gt; <span class="keyword">implements</span> <span class="title">ActionHook</span>, <span class="title">Processor</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> StringManager sm = StringManager.getManager(Constants.Package);</span><br><span class="line">        <span class="keyword">protected</span> Adapter adapter;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">final</span> AsyncStateMachine asyncStateMachine ;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">final</span> AbstractEndpoint&lt;S&gt; endpoint ;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">final</span> Request request ;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">final</span> Response response ;</span><br><span class="line">        <span class="keyword">protected</span> SocketWrapper&lt;S&gt; socketWrapper = <span class="keyword">null</span> ;</span><br></pre></td></tr></table></figure></p>
<p> 一个Adapter对象，用来和tomcat容器进行关联，这里是实现了和Connector的关联。<br>          Adapter的作用在其注释中描述如下“Adapter. This represents the entry point in a coyote -based servlet container.”<br>     一个AbstractEndpoint对象，用来和Endpoint模块进行关联，实现对基础网络I/O的屏蔽。</p>
<p>AbstractHttp11Processor中包含了更多的处理http请求相关的细节，包括使用的http协议、socket的维持状态、内容压缩等。同时，更重要的一点是，它实现了process方法，这是整个Socket Processor框架处理http请求的核心部分。从实现的process方法中，可以看出Socket Processor框架的工作原理。 process方法做了各种分支的检查，处理了http请求的各种状态。根据所处理的http请求的状态，设置request和response的状态，最后正常的http请求相关的业务，会交由Adapter的service去进行处理，转移到Connector上来执行。</p>
<p><strong>[Endpoint]</strong><br>Endpoint是基础的网络设施，通过Endpoint来实现网络连接和控制，它是服务器对外I/O操作的接入点。主要任务是管理对外的socket连接，同时将建立好的socket连接交到合适的工作线程中去。<br>content：org.apache.tomcat.util.net.AbstractEndpoint，org.apache.tomcat.util.net.NioEndpoint</p>
<p>对于AbstractEndpoint主要关注它的以下几个属性<br>     private Executor executor = null;   执行业务的线程池，如果外部没有指定线程池，就使用Endpoint内部的线程池<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Threads used <span class="keyword">to</span> accept <span class="keyword">new</span> connections <span class="keyword">and</span> pass them <span class="keyword">to</span> worker threads.</span><br><span class="line">*/</span><br><span class="line"> <span class="keyword">protected</span> Acceptor[] acceptors;  管理连接</span><br></pre></td></tr></table></figure></p>
<p>对于NioEndpoint主要关注它的一下几个属性<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Handling of accepted sockets.</span><br><span class="line"> */</span></span><br><span class="line">private <span class="operator"><span class="keyword">Handler</span> <span class="keyword">handler</span> = <span class="literal">null</span> ;</span> 处理socket连接的<span class="operator"><span class="keyword">handler</span>，属于业务处理部分，在executor线程池中执行</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * The socket poller.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> Poller[] pollers = <span class="literal">null</span> ;</span> 监听socket事件，调用<span class="operator"><span class="keyword">handler</span>进行socket处理。</span></span><br></pre></td></tr></table></figure></p>
<p>它的内部组成包括Poller线程组和Acceptor线程组。</p>
<p>Acceptor线程组负责接收来自外部的网络连接请求，并将建立好的连接，交到Poller线程组去处理。Acceptor的具体工作原理，可以从NioEndpoint$Acceptor.run方法中可以看出，(countUpOrAwaitConnection)控制接收的连接的数量，对接收的连接，(setSocketOptions)将其注册到Poller线程组中，如果在操作过程中遇到错误，则关闭连接。连接注册到Poller线程组后，Poller就能够读取连接中的数据，并进行处理。注册到Poller线程上的效果，是将socket封装后放入Poller线程内部维护的一个PollerEvent队列中，然后Poller线程运行时处理队列，将socket注册到这个Poller的Selector上。</p>
<p>Poller线程组负责对已建立连接的socket进行处理。从NioEndpoint$Poller.run方法中可以看出Poller线程的工作原理，基于Java NIO来进行网络的读写。在run方法中，通过selector.select系列方法来获取数据，然后经由processKey到processSocket方法，封装成一个SocketProcessor对象后，放在EndPoint的线程池中执行，但实际的业务处理部分，是通过Endpoint的Handler进行处理。</p>
<p>下面简要说下后面的处理流程<br><strong>SocketProcessor</strong> –&gt;  <strong>Http11ConnectionHandler</strong> –&gt;  <strong>Http11Processor</strong> –&gt;  <strong>CoyoteApapter</strong> –&gt;  <strong>StandardEngineValve</strong> –&gt;  <strong>StandHostValve</strong> –&gt;  <strong>StandardContextValve</strong> –&gt;  <strong>StandardWrapperValve</strong> –&gt;  <strong>Application Filter Chain</strong> –&gt;  <strong>Servlet</strong></p>
<p>文章参考来源：大神 <a href="http://blog.csdn.net/yanlinwang/article/category/1398223" target="_blank" rel="external">http://blog.csdn.net/yanlinwang/article/category/1398223</a><br><a href="http://blog.csdn.net/cutesource/article/category/631854" target="_blank" rel="external">http://blog.csdn.net/cutesource/article/category/631854</a><br>明天继续，总结下深入剖析Tomcat，Tomcat的深入了解告一段落，开启新的路程。</p>

    </div>
    <footer>
        
        
		<div class="bdsharebuttonbox">
	<a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
	<a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_count" data-cmd="count"></a>
</div>
<script>
window._bd_share_config=
{
	"common":{
		"bdSnsKey":{},
		"bdText":"",
		"bdMini":"2",
		"bdMiniList":false,
		"bdPic":"",
		"bdStyle":"0",
		"bdSize":"24"
	},
	"share":{},
	"image":{
		"viewList":["qzone","tsina","tqq","renren","weixin","fbook","twi"],
		"viewText":"分享到：",
		"viewSize":"24"
	},
	"selectShare":{
		"bdContainerClass":null,
		"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin","fbook","twi"]
	}
};
with(document)0[
	(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)
];
</script>    
        <div class="clearfix"></div>
    </footer>
  </div>
</article>

 <nav id="pagination" >
    
    
    <a href="/2016/01/13/Java-TCP-IP-Socket编程/" class="alignright next" title="Java TCP/IP Socket编程">Java TCP/IP Socket编程</a>
    
    <div class="clearfix"></div>
</nav>



	
	<section id="comment">
		<!-- 多说评论框 start -->
		<div class="ds-thread" data-thread-key="2016/01/16/Tomcat8-源码解读/" data-title="Tomcat8 源码解读" data-url="http://zc14.github.io/2016/01/16/Tomcat8-源码解读/"></div>
		<!-- 多说评论框 end -->
		<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
		<script type="text/javascript">
		var duoshuoQuery = {short_name:"http://zc14.github.io/"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
		<!-- 多说公共JS代码 end -->
	</section>
	
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" id="zc14-search-input" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:zc14.github.io">
  </form>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/hello/">hello</a><small>1</small></li>
  
    <li><a href="/categories/markdown/">markdown</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/并发编程/" style="font-size: 10px;">并发编程</a> <a href="/tags/开始/" style="font-size: 10px;">开始</a> <a href="/tags/金典/" style="font-size: 20px;">金典</a> <a href="/tags/面试/" style="font-size: 10px;">面试</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <!--
  <footer id="footer"><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/huangjunhui/concise" target="_blank" title="Concise">Concise</a> © 2016 
		
		<a href="http://zc14.github.io/about" target="_blank" title="周聪">周聪</a>
		
		</p>
</div>
</footer>
  -->
  <script src="//libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/counter.js"></script>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

	  _st('install','ZsQjP1Wjp4ayEpx825-R','2.0.0');
</script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

<div id="totop" style="position:fixed;bottom:100px;right:10px;cursor: pointer;">
<a title="返回顶部"><img src="/imgs/scrollup.png"/></a>
</div>
<script src="/js/totop.js"></script>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>


